<script type="text/javascript" src="http://sales.carerix.com/templates/facturen/jquery.actual.min.js"></script>  
<script type="text/javascript"><!--
	; (function($) {
		var $container = null;
		
		if ( !console ) console = {log: $.noop};
		
		/**
		 * Build an invoice report row (template method)
		 */
		function _buildRow(it) {
			var $row, html;
			console.log('_buildRow');
			if ( it<=1 && this.company.invoiceEmail !== '' ) { // TODO: remove it condition
				$row = $('<tr data-role="invoice-export-row">'
					+ '<th class="sub"><input type="checkbox" checked="checked"/></th>'
						+ '<td>' + this.company.name + '</td>'
						+ '<td>' + this.company.invoiceEmail + '</td>'  
						+ '<td>&euro; ' + this.getParsedSubtotal() + '</td>'  
						+ '<td><button data-role="send-mailing">Versturen</button></td>'
						+ '<td><button data-role="download-invoice">Downloaden</button></td>'
					+ '</tr>'
				);
				$row.appendTo($container);
			} else {
				$row = $('<tr data-role="invoice-export-row">'
						+ '<th class="sub"><input type="checkbox" disabled="disabled"/></th>'
						+ '<td>' + this.company.name + '</td>'
						+ '<td>GEEN ADRES BESCHIKBAAR</td>'  
						+ '<td>&euro; ' + this.getParsedSubtotal() + '</td>'  
						+ '<td><button class="inactive">Versturen</button></td>'
						+ '<td><button data-role="download-invoice">Downloaden</button></td>'
					+ '</tr>'
				);
				$row.prependTo($container);
			}
			$row.data('invoice', this);
		} // _buildRow();
		
		/**
		 * Send a single mail
		 * Will also be used as target for the sendAll mails
		 */
		function _sendMail() {
			var $top = $(this).closest('tr'),
//					id = $top.data('invoice'),
//					invoiceHTML = "<html><head><title>test</title><meta http-equiv='Content-Type' content='text/html; charset=utf-8'></head><body>" + $('[data-invoice-id=' + id + ']').html() + "</body></html>",
//					iframe = $('#tmpIFrame'),
//					url = 'http://' 
//									+ document.URL.substr(document.URL.indexOf('://') + 3, document.URL.indexOf('.') - document.URL.indexOf('://') - 3)
//									+ '.carerix.net/cgi-bin/nph-proxy.cgi/h0/http/tools.carerix.com/cxconverter/run.php',
//					$form = $('<form method="post" action="' + url + '" target="tmpIframe" style="display: none"><textarea name="url">' + invoiceHTML + '</textarea></form>');
				it;
	
			// Finally: report the fact that this email has been sent.
			$top.trigger('set-send');
		} // _sendMail();
		
		/**
		 * Download the PDF pertaining to the invoice, as the end user would get it
		 */
		function _downloadInvoicePDF() {
			var $this = $(this),
					invoice = $this.data('invoice'),
					$invoice = $('[data-invoice-id=' + invoice.id + ']'),
					invoiceHTML = "<html><head>"
							+ "<title>Factuur</title>"
							+ "<meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>"
							+ "</head><body>" 
							+ $invoice.html() 
							+ "</body></html>",
					iframe = $('#tmpIFrame'),
					url = 'http://tools.carerix.com/cxconverter/run.php', // endpoint uri for the CxConverter
					$form = $('<form method="post" action="' + url + '" target="tmpIframe" style="display: none">'
							+ '<textarea name="url">' + invoiceHTML + '</textarea>'
							+ '<input name="pdf_name" value="' + (invoice.it + initialInvoiceNumber) + '"/>'
							+ '<input name="media" value="A4"/>'
							+ '<input name="cssmedia" value="print"/>'
							+ '<input name="pixels" value="' + ($invoice.find('.noborder').actual('width')+10) + 'x' + ($invoice.actual('height')+10) + '"/>'
							+ '<input name="leftmargin" value="15"/>'
							+ '<input name="rightmargin" value="15"/>'
							+ '</form>');
					
			if ( iframe.length === 0 ) {
				iframe = $('<iframe id="tmpIframe" name="tmpIframe" style="display: none"/>').appendTo('body');
			}
			
			$('body').append($form);
			setTimeout(function() { 
				$form.trigger('submit');
				setTimeout($form.remove, 1);
			}, 100);
		} // _downloadInvoicePDF();
		
		/**
		 * Set the presentation of this row to "mail sent"
		 */
		function _setSend() {
			var $this = $(this);
			$this.find(':checkbox').attr('checked', 'checked').attr('disabled', 'disabled');
			$this.find('button').html('Verstuurd').addClass('inactive');
		} // _setSend();
		
		/**
		 * Trigger the send single mail action
		 */
		function _triggerSendMail() {
			$(this).closest('[data-role="invoice-export-row"]').trigger('send-email');
		} // _triggerSendMail();
		
		/**
		 * Trigger the download PDF event
		 */
		function _triggerDownloadInvoicePDF() {
			$(this).closest('[data-role="invoice-export-row"]').trigger('download');
		} // _triggerDownloadInvoicePDF();
		
		/**
		 * Trigger sending all emails by iterating through the desired emails and 
		 * triggering each of their send-email events.
		 */
		function _sendAllMails() {
			$container.find(':checkbox:checked:not(:disabled)').each(function() {
				$(this).closest('[data-role="invoice-export-row"]').trigger('send-email');
			});
		} // _sendAllMails
		
		/**
		 * Bind the events
		 */
		$(document).on('send-email', '[data-role="invoice-export-row"]', _sendMail);
		$(document).on('download', '[data-role="invoice-export-row"]', _downloadInvoicePDF);
		$(document).on('set-send', '[data-role="invoice-export-row"]', _setSend);
		$(document).on('click', '[data-role=send-mailing]', _triggerSendMail);
		$(document).on('click', '[data-role=download-invoice]', _triggerDownloadInvoicePDF);
		$(document).on('click', '[data-role=send-all-email]', _sendAllMails); 

		/**
		 * When the document has been created: build the table
		 */
		$(document).ready(function() {
			$container = $('#invoiceMailingsTable tbody');
			$.each(getProjects(), _buildRow);
		});
		
	})(jQuery);
--></script>
<style type="text/css" >
	table#invoiceMailingsTable button {
		cursor: pointer;
		float: right;
		font-size: 1.1em;
		color: #ffffff;
		padding: .3em 1em;
		background: #ffa442;
		background: -moz-linear-gradient(top,	#ffa442 0%,	#665200);
		background: -webkit-gradient(linear, left top, left bottom,	from(#ffa442), to(#665200));
		border-radius: 10px;
		border: 1px solid #660000;
		box-shadow:	0px 1px 3px rgba(000,000,000,0.5), inset 0px 0px 1px rgba(255,255,255,0.5);
		text-shadow: 0px -1px 0px rgba(000,000,000,0.7), 0px 1px 0px rgba(255,255,255,0.3);
	}
	table#invoiceMailingsTable button.inactive {
		color: #ccc;
	}
</style>
<button data-role="send-all-email">Send all emails</button>
<style type="text/css" media="print">
	table#invoiceMailingsTable button {
		border: none;
		border-radius: none;
		padding: auto;
		font-size: 1em;
		text-shadow: none;
	}
</style>

<table id="invoiceMailingsTable" class='border'>
	<thead>
		<th/>
		<th>Bedrijf</th>
		<th>Email adres</th>
		<th>Bedrag</th>
		<th/>
		<th/>
	</thead>
	<tbody/>
</table>